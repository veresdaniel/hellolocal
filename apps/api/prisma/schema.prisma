// apps/api/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Lang {
  hu
  en
  de
}

enum SlugEntityType {
  place
  placeType
  town
  page
  region
  event
}

enum UserRole {
  superadmin
  admin
  editor
  viewer
  // Future roles can be added here
}

// Removed PlaceCategory and PriceBand enums - now they are entities

model Tenant {
  id               String   @id @default(cuid())
  slug             String   @unique
  isActive         Boolean  @default(true)

  // optional: for domain/whitelabel later
  primaryDomain    String?  @unique

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  towns            Town[]
  places           Place[]
  events           Event[]
  legalPages       LegalPage[]
  staticPages      StaticPage[]
  translations     TenantTranslation[]

  tenantKeys       TenantKey[]
  slugs            Slug[]
  categories       Category[]
  tags             Tag[]
  priceBands       PriceBand[]
  users            UserTenant[]
  pushSubscriptions PushSubscription[]
  eventLogs        EventLog[]
}

model TenantTranslation {
  id              String  @id @default(cuid())
  tenantId        String
  lang            Lang

  name            String
  shortDescription String? // HTML
  description     String?  // HTML
  heroImage       String?

  // SEO (per language)
  seoTitle        String?
  seoDescription  String?
  seoImage        String?
  seoKeywords     String[] @default([])

  tenant          Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, lang])
  @@index([lang])
}

model TenantKey {
  id            String   @id @default(cuid())
  tenantId      String
  lang          Lang
  slug          String

  isPrimary     Boolean  @default(true)
  isActive      Boolean  @default(true)

  redirectToId  String?
  redirectTo    TenantKey?  @relation("TenantKeyRedirect", fields: [redirectToId], references: [id], onDelete: SetNull)
  redirectsFrom TenantKey[] @relation("TenantKeyRedirect")

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([lang, slug])
  @@index([lang, slug])
  @@index([tenantId, lang])
}

model Slug {
  id            String         @id @default(cuid())
  tenantId      String
  lang          Lang
  slug          String

  entityType    SlugEntityType
  entityId      String

  isPrimary     Boolean        @default(true)
  isActive      Boolean        @default(true)

  redirectToId  String?
  redirectTo    Slug?          @relation("SlugRedirect", fields: [redirectToId], references: [id], onDelete: SetNull)
  redirectsFrom Slug[]         @relation("SlugRedirect")

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, lang, slug])
  @@index([tenantId, lang, slug])
  @@index([tenantId, entityType, entityId])
}

model Town {
  id         String   @id @default(cuid())
  tenantId   String
  isActive   Boolean  @default(true)

  // Map coordinates
  lat        Float?
  lng        Float?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  places     Place[]
  translations TownTranslation[]

  @@index([tenantId])
}

model TownTranslation {
  id              String @id @default(cuid())
  townId          String
  lang            Lang

  name            String
  description     String? // HTML
  heroImage       String?

  // SEO
  seoTitle        String?
  seoDescription  String?
  seoImage        String?
  seoKeywords     String[] @default([])

  town            Town   @relation(fields: [townId], references: [id], onDelete: Cascade)

  @@unique([townId, lang])
  @@index([lang])
}

model Category {
  id         String   @id @default(cuid())
  tenantId   String
  parentId   String?  // Parent category for hierarchy
  isActive   Boolean  @default(true)
  color      String?  // Hex color code for card border (e.g., "#667eea")
  order      Int      @default(0) // Sort order within parent (or root level)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parent     Category? @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children   Category[] @relation("CategoryHierarchy")
  translations CategoryTranslation[]
  places     Place[]
  events     Event[]
  eventCategories EventCategory[]

  @@index([tenantId])
  @@index([parentId])
  @@index([tenantId, parentId, order])
}

model CategoryTranslation {
  id          String   @id @default(cuid())
  categoryId String
  lang        Lang

  name        String
  description String? // HTML

  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, lang])
  @@index([lang])
}

model Tag {
  id         String   @id @default(cuid())
  tenantId   String
  isActive   Boolean  @default(true)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  translations TagTranslation[]
  places     PlaceTag[]
  events     EventTag[]

  @@index([tenantId])
}

model TagTranslation {
  id          String   @id @default(cuid())
  tagId       String
  lang        Lang

  name        String
  description String? // HTML

  tag         Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([tagId, lang])
  @@index([lang])
}

model PriceBand {
  id         String   @id @default(cuid())
  tenantId   String
  isActive   Boolean  @default(true)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  translations PriceBandTranslation[]
  places     Place[]

  @@index([tenantId])
}

model PriceBandTranslation {
  id          String   @id @default(cuid())
  priceBandId String
  lang        Lang

  name        String
  description String? // HTML

  priceBand   PriceBand @relation(fields: [priceBandId], references: [id], onDelete: Cascade)

  @@unique([priceBandId, lang])
  @@index([lang])
}

model Place {
  id          String        @id @default(cuid())
  tenantId    String
  townId      String?
  ownerId    String?

  categoryId  String
  isActive    Boolean       @default(true)

  // Media + discoverability
  heroImage   String?
  gallery     String[]      @default([])

  // Map
  lat         Float?
  lng         Float?

  priceBandId String?

  // Aggregated rating (read-only in v1; write later)
  ratingAvg   Float?        // e.g. 4.6
  ratingCount Int?          // e.g. 18

  // Flexible details (capacity, services, etc.)
  extras      Json?

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  tenant      Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  town        Town?         @relation(fields: [townId], references: [id], onDelete: SetNull)
  category    Category      @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  priceBand   PriceBand?    @relation(fields: [priceBandId], references: [id], onDelete: SetNull)
  owner       User?         @relation("PlaceOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  translations PlaceTranslation[]
  tags        PlaceTag[]
  events      Event[]
  openingHours PlaceOpeningHours[]

  @@index([tenantId, categoryId])
  @@index([townId])
}

// Opening hours for places (one entry per day of week)
model PlaceOpeningHours {
  id        String   @id @default(cuid())
  placeId   String
  dayOfWeek Int      // 0 = Monday, 1 = Tuesday, ..., 6 = Sunday
  isClosed  Boolean  @default(false) // If true, place is closed on this day
  openTime  String?  // Format: "HH:mm" (e.g., "09:00"), null if isClosed
  closeTime String?  // Format: "HH:mm" (e.g., "17:30"), null if isClosed
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  place     Place    @relation(fields: [placeId], references: [id], onDelete: Cascade)
  
  @@unique([placeId, dayOfWeek])
  @@index([placeId])
}

// Many-to-many relationship between Place and Tag
model PlaceTag {
  id        String   @id @default(cuid())
  placeId   String
  tagId     String

  createdAt DateTime @default(now())

  place     Place    @relation(fields: [placeId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([placeId, tagId])
  @@index([placeId])
  @@index([tagId])
}

model PlaceTranslation {
  id              String  @id @default(cuid())
  placeId         String
  lang            Lang

  name            String
  // HTML content
  teaser          String? // short HTML for list
  description     String? // full HTML for detail

  // Contact-ish fields (can be HTML or plain)
  address         String? // HTML or plain
  phone           String?
  email           String?
  website         String?

  openingHours    String? // HTML
  accessibility   String? // HTML

  // SEO
  seoTitle        String?
  seoDescription  String?
  seoImage        String?
  seoKeywords     String[] @default([])

  place           Place   @relation(fields: [placeId], references: [id], onDelete: Cascade)

  @@unique([placeId, lang])
  @@index([lang])
}

model LegalPage {
  id         String   @id @default(cuid())
  tenantId   String
  key        String   // imprint | terms | privacy
  isActive   Boolean  @default(true)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  translations LegalPageTranslation[]

  @@unique([tenantId, key])
  @@index([tenantId])
}

model LegalPageTranslation {
  id              String @id @default(cuid())
  legalPageId     String
  lang            Lang

  title           String
  content         String? // HTML

  // SEO
  seoTitle        String?
  seoDescription  String?
  seoImage        String?
  seoKeywords     String[] @default([])

  legalPage       LegalPage @relation(fields: [legalPageId], references: [id], onDelete: Cascade)

  @@unique([legalPageId, lang])
  @@index([lang])
}

model StaticPage {
  id         String   @id @default(cuid())
  tenantId   String
  category   String   // blog | tudastar | infok
  isActive   Boolean  @default(true)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  translations StaticPageTranslation[]

  @@index([tenantId])
  @@index([category])
}

model StaticPageTranslation {
  id              String @id @default(cuid())
  staticPageId    String
  lang            Lang

  title           String
  content         String? // HTML

  // SEO
  seoTitle        String?
  seoDescription   String?
  seoImage        String?
  seoKeywords     String[] @default([])

  staticPage      StaticPage @relation(fields: [staticPageId], references: [id], onDelete: Cascade)

  @@unique([staticPageId, lang])
  @@index([lang])
}

model User {
  id            String   @id @default(cuid())
  username      String   @unique
  email         String   @unique
  passwordHash  String   // bcrypt hashed password
  
  firstName     String
  lastName      String
  bio           String?
  
  role          UserRole @default(viewer)
  isActive      Boolean  @default(true)
  
  // Password reset
  resetToken    String?
  resetTokenExpiresAt DateTime?
  
  // Session management
  refreshToken  String?
  refreshTokenExpiresAt DateTime?
  
  // Two-Factor Authentication (2FA)
  totpSecret    String?  // TOTP secret for 2FA
  isTwoFactorEnabled Boolean @default(false) // Whether 2FA is enabled for this user
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Many-to-many with tenants (user can belong to multiple tenants)
  tenants       UserTenant[]
  
  // Place ownership (for future - when user has appropriate role)
  ownedPlaces   Place[]  @relation("PlaceOwner")
  
  // Event logs for this user's activities
  eventLogs     EventLog[]
  
  @@index([email])
  @@index([username])
  @@index([isActive])
}

// Junction table for many-to-many relationship between User and Tenant
model UserTenant {
  id        String   @id @default(cuid())
  userId    String
  tenantId  String
  isPrimary Boolean   @default(false) // One tenant can be marked as primary
  
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@unique([userId, tenantId])
  @@index([userId])
  @@index([tenantId])
}

// Application settings (global, not tenant-specific)
model AppSetting {
  id        String   @id @default(cuid())
  key       String   @unique // e.g., "defaultLanguage", "appName", etc.
  value     String   // JSON string or simple string value
  type      String   @default("string") // "string", "number", "boolean", "json"
  description String? // Human-readable description
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([key])
}

model Event {
  id         String   @id @default(cuid())
  tenantId   String
  placeId    String?  // Optional: event can be linked to a place
  categoryId String?  // Optional: event can have a category
  isActive   Boolean  @default(true)
  isPinned   Boolean  @default(false) // Pinned events appear at top of lists
  isRainSafe Boolean  @default(false) // Whether the event is rain-safe (indoor or covered)
  startDate  DateTime // Event start date/time
  endDate    DateTime? // Optional end date/time
  heroImage  String?  // Hero image URL
  gallery    String[]  @default([]) // Array of image URLs
  lat        Float?    // Optional latitude for map display
  lng        Float?    // Optional longitude for map display
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  place      Place?   @relation(fields: [placeId], references: [id], onDelete: SetNull)
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull) // Legacy: kept for backward compatibility
  translations EventTranslation[]
  tags       EventTag[]
  categories EventCategory[] // Many-to-many relationship with categories
  
  @@index([tenantId, startDate])
  @@index([placeId])
  @@index([categoryId])
}

model EventTranslation {
  id          String @id @default(cuid())
  eventId     String
  lang        Lang
  
  title       String
  shortDescription String? // 2-line description
  description String? // Full description (HTML)
  
  // SEO
  seoTitle        String?
  seoDescription  String?
  seoImage        String?
  seoKeywords     String[] @default([])
  
  event       Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  @@unique([eventId, lang])
  @@index([lang])
}

model EventTag {
  id      String @id @default(cuid())
  eventId String
  tagId   String
  
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tag     Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([eventId, tagId])
  @@index([eventId])
  @@index([tagId])
}

// Many-to-many relationship between Event and Category
model EventCategory {
  id         String   @id @default(cuid())
  eventId    String
  categoryId String
  
  createdAt  DateTime @default(now())
  
  event      Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  @@unique([eventId, categoryId])
  @@index([eventId])
  @@index([categoryId])
}

// Push notification subscriptions
model PushSubscription {
  id         String   @id @default(cuid())
  tenantId   String
  endpoint   String   @unique
  p256dh     String   // Public key
  auth       String   // Auth secret
  
  userAgent  String?  // Optional: browser/device info
  isActive   Boolean  @default(true)
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@index([isActive])
}

// Event log for tracking user activities (superadmin and admin only)
model EventLog {
  id          String   @id @default(cuid())
  tenantId    String
  userId      String   // User who performed the action
  action      String   // e.g., "create", "update", "delete", "login", "logout"
  entityType  String?  // e.g., "place", "event", "category", "tag", "user", etc.
  entityId    String?  // ID of the affected entity (if applicable)
  description String?  // Human-readable description of the action
  metadata    Json?    // Additional context (e.g., changed fields, IP address, etc.)
  
  createdAt   DateTime @default(now())
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
  @@index([tenantId, userId])
  @@index([tenantId, createdAt])
}