// apps/api/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

enum Lang {
  hu
  en
  de
}

enum SlugEntityType {
  place
  placeType
  town
  page
  region
}

enum UserRole {
  superadmin
  admin
  editor
  viewer
  // Future roles can be added here
}

// Removed PlaceCategory and PriceBand enums - now they are entities

model Tenant {
  id               String   @id @default(cuid())
  slug             String   @unique
  isActive         Boolean  @default(true)

  // optional: for domain/whitelabel later
  primaryDomain    String?  @unique

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  towns            Town[]
  places           Place[]
  legalPages       LegalPage[]
  translations     TenantTranslation[]

  tenantKeys      TenantKey[]
  slugs            Slug[]
  categories       Category[]
  tags             Tag[]
  priceBands       PriceBand[]
  users            UserTenant[]
}

model TenantTranslation {
  id              String  @id @default(cuid())
  tenantId        String
  lang            Lang

  name            String
  shortDescription String? // HTML
  description     String?  // HTML
  heroImage       String?

  // SEO (per language)
  seoTitle        String?
  seoDescription  String?
  seoImage        String?
  seoKeywords     String[] @default([])

  tenant          Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, lang])
  @@index([lang])
}

model TenantKey {
  id            String   @id @default(cuid())
  tenantId      String
  lang          Lang
  slug          String

  isPrimary     Boolean  @default(true)
  isActive      Boolean  @default(true)

  redirectToId  String?
  redirectTo    TenantKey?  @relation("TenantKeyRedirect", fields: [redirectToId], references: [id], onDelete: SetNull)
  redirectsFrom TenantKey[] @relation("TenantKeyRedirect")

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([lang, slug])
  @@index([lang, slug])
  @@index([tenantId, lang])
}

model Slug {
  id            String         @id @default(cuid())
  tenantId      String
  lang          Lang
  slug          String

  entityType    SlugEntityType
  entityId      String

  isPrimary     Boolean        @default(true)
  isActive      Boolean        @default(true)

  redirectToId  String?
  redirectTo    Slug?          @relation("SlugRedirect", fields: [redirectToId], references: [id], onDelete: SetNull)
  redirectsFrom Slug[]         @relation("SlugRedirect")

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, lang, slug])
  @@index([tenantId, lang, slug])
  @@index([tenantId, entityType, entityId])
}

model Town {
  id         String   @id @default(cuid())
  tenantId   String
  isActive   Boolean  @default(true)

  // Map coordinates
  lat        Float?
  lng        Float?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  places     Place[]
  translations TownTranslation[]

  @@index([tenantId])
}

model TownTranslation {
  id              String @id @default(cuid())
  townId          String
  lang            Lang

  name            String
  description     String? // HTML
  heroImage       String?

  // SEO
  seoTitle        String?
  seoDescription  String?
  seoImage        String?
  seoKeywords     String[] @default([])

  town            Town   @relation(fields: [townId], references: [id], onDelete: Cascade)

  @@unique([townId, lang])
  @@index([lang])
}

model Category {
  id         String   @id @default(cuid())
  tenantId   String
  isActive   Boolean  @default(true)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  translations CategoryTranslation[]
  places     Place[]

  @@index([tenantId])
}

model CategoryTranslation {
  id          String   @id @default(cuid())
  categoryId String
  lang        Lang

  name        String
  description String? // HTML

  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, lang])
  @@index([lang])
}

model Tag {
  id         String   @id @default(cuid())
  tenantId   String
  isActive   Boolean  @default(true)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  translations TagTranslation[]
  places     PlaceTag[]

  @@index([tenantId])
}

model TagTranslation {
  id          String   @id @default(cuid())
  tagId       String
  lang        Lang

  name        String
  description String? // HTML

  tag         Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([tagId, lang])
  @@index([lang])
}

model PriceBand {
  id         String   @id @default(cuid())
  tenantId   String
  isActive   Boolean  @default(true)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  translations PriceBandTranslation[]
  places     Place[]

  @@index([tenantId])
}

model PriceBandTranslation {
  id          String   @id @default(cuid())
  priceBandId String
  lang        Lang

  name        String
  description String? // HTML

  priceBand   PriceBand @relation(fields: [priceBandId], references: [id], onDelete: Cascade)

  @@unique([priceBandId, lang])
  @@index([lang])
}

model Place {
  id          String        @id @default(cuid())
  tenantId    String
  townId      String?
  ownerId    String?

  categoryId  String
  isActive    Boolean       @default(true)

  // Media + discoverability
  heroImage   String?
  gallery     String[]      @default([])

  // Map
  lat         Float?
  lng         Float?

  priceBandId String?

  // Aggregated rating (read-only in v1; write later)
  ratingAvg   Float?        // e.g. 4.6
  ratingCount Int?          // e.g. 18

  // Flexible details (capacity, services, etc.)
  extras      Json?

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  tenant      Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  town        Town?         @relation(fields: [townId], references: [id], onDelete: SetNull)
  category    Category      @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  priceBand   PriceBand?    @relation(fields: [priceBandId], references: [id], onDelete: SetNull)
  owner       User?         @relation("PlaceOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  translations PlaceTranslation[]
  tags        PlaceTag[]

  @@index([tenantId, categoryId])
  @@index([townId])
}

// Many-to-many relationship between Place and Tag
model PlaceTag {
  id        String   @id @default(cuid())
  placeId   String
  tagId     String

  createdAt DateTime @default(now())

  place     Place    @relation(fields: [placeId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([placeId, tagId])
  @@index([placeId])
  @@index([tagId])
}

model PlaceTranslation {
  id              String  @id @default(cuid())
  placeId         String
  lang            Lang

  name            String
  // HTML content
  teaser          String? // short HTML for list
  description     String? // full HTML for detail

  // Contact-ish fields (can be HTML or plain)
  address         String? // HTML or plain
  phone           String?
  email           String?
  website         String?

  openingHours    String? // HTML
  accessibility   String? // HTML

  // SEO
  seoTitle        String?
  seoDescription  String?
  seoImage        String?
  seoKeywords     String[] @default([])

  place           Place   @relation(fields: [placeId], references: [id], onDelete: Cascade)

  @@unique([placeId, lang])
  @@index([lang])
}

model LegalPage {
  id         String   @id @default(cuid())
  tenantId   String
  key        String   // imprint | terms | privacy
  isActive   Boolean  @default(true)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  translations LegalPageTranslation[]

  @@unique([tenantId, key])
  @@index([tenantId])
}

model LegalPageTranslation {
  id              String @id @default(cuid())
  legalPageId     String
  lang            Lang

  title           String
  content         String? // HTML

  // SEO
  seoTitle        String?
  seoDescription  String?
  seoImage        String?
  seoKeywords     String[] @default([])

  legalPage       LegalPage @relation(fields: [legalPageId], references: [id], onDelete: Cascade)

  @@unique([legalPageId, lang])
  @@index([lang])
}

model User {
  id            String   @id @default(cuid())
  username      String   @unique
  email         String   @unique
  passwordHash  String   // bcrypt hashed password
  
  firstName     String
  lastName      String
  bio           String?
  
  role          UserRole @default(viewer)
  isActive      Boolean  @default(true)
  
  // Password reset
  resetToken    String?
  resetTokenExpiresAt DateTime?
  
  // Session management
  refreshToken  String?
  refreshTokenExpiresAt DateTime?
  
  // Two-Factor Authentication (2FA)
  totpSecret    String?  // TOTP secret for 2FA
  isTwoFactorEnabled Boolean @default(false) // Whether 2FA is enabled for this user
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Many-to-many with tenants (user can belong to multiple tenants)
  tenants       UserTenant[]
  
  // Place ownership (for future - when user has appropriate role)
  ownedPlaces   Place[]  @relation("PlaceOwner")
  
  @@index([email])
  @@index([username])
  @@index([isActive])
}

// Junction table for many-to-many relationship between User and Tenant
model UserTenant {
  id        String   @id @default(cuid())
  userId    String
  tenantId  String
  isPrimary Boolean   @default(false) // One tenant can be marked as primary
  
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@unique([userId, tenantId])
  @@index([userId])
  @@index([tenantId])
}

// Application settings (global, not tenant-specific)
model AppSetting {
  id        String   @id @default(cuid())
  key       String   @unique // e.g., "defaultLanguage", "appName", etc.
  value     String   // JSON string or simple string value
  type      String   @default("string") // "string", "number", "boolean", "json"
  description String? // Human-readable description
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([key])
}